{% extends "base.html" %}
{% block title %}All Bookings - Admin - ParkHub{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-1">
            <i class="bi bi-list-check me-2"></i>All Bookings
        </h4>
        <p class="text-muted mb-0">Manage and monitor all parking reservations</p>
    </div>
    <a href="{{ url_for('admin_analytics') }}" class="btn btn-outline-primary">
        <i class="bi bi-pie-chart-fill me-1"></i>Analytics
    </a>
</div>

<!-- Stats Cards -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="stat-card">
            <div class="stat-value text-primary">{{ stats.total }}</div>
            <div class="stat-label">Total Bookings</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card">
            <div class="stat-value" style="color: #3B82F6;">{{ stats.active }}</div>
            <div class="stat-label">Active</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card">
            <div class="stat-value" style="color: #10B981;">{{ stats.completed }}</div>
            <div class="stat-label">Completed</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card">
            <div class="stat-value" style="color: #EF4444;">{{ stats.cancelled }}</div>
            <div class="stat-label">Cancelled</div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body py-3">
        <form method="GET" action="{{ url_for('admin_bookings') }}" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select name="status" class="form-select">
                    <option value="all" {% if status_filter=='all' %}selected{% endif %}>All Status</option>
                    <option value="active" {% if status_filter=='active' %}selected{% endif %}>Active</option>
                    <option value="completed" {% if status_filter=='completed' %}selected{% endif %}>Completed</option>
                    <option value="cancelled" {% if status_filter=='cancelled' %}selected{% endif %}>Cancelled</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Date Range</label>
                <select name="date" class="form-select">
                    <option value="all" {% if date_filter=='all' %}selected{% endif %}>All Time</option>
                    <option value="today" {% if date_filter=='today' %}selected{% endif %}>Today</option>
                    <option value="week" {% if date_filter=='week' %}selected{% endif %}>This Week</option>
                    <option value="month" {% if date_filter=='month' %}selected{% endif %}>This Month</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Peak Time</label>
                <select name="peak" class="form-select">
                    <option value="all" {% if peak_filter=='all' %}selected{% endif %}>All Hours</option>
                    <option value="peak" {% if peak_filter=='peak' %}selected{% endif %}>Peak Hours (9-11 AM, 2-3 PM)
                    </option>
                    <option value="off_peak" {% if peak_filter=='off_peak' %}selected{% endif %}>Off-Peak Hours</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-funnel me-1"></i>Apply Filters
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Results Count -->
<div class="mb-3">
    <span class="text-muted">Showing {{ stats.filtered }} booking(s)</span>
</div>

<!-- Bookings Table -->
{% if bookings %}
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>User</th>
                        <th>Slot</th>
                        <th>Vehicle</th>
                        <th>Date & Time</th>
                        <th>Duration</th>
                        <th>Price</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in bookings %}
                    <tr>
                        <td><strong>#{{ booking.id }}</strong></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-person-circle text-muted me-2"></i>
                                <div>
                                    <div class="small fw-medium">{{ booking.user.name if booking.user else 'N/A' }}
                                    </div>
                                    <div class="small text-muted">{{ booking.user.email if booking.user else '' }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-light text-dark">
                                <i class="bi bi-geo-alt text-primary me-1"></i>
                                {{ booking.slot.slot_number|format_slot if booking.slot else 'N/A' }}
                            </span>
                        </td>
                        <td>
                            <code>{{ booking.vehicle_number }}</code>
                        </td>
                        <td>
                            <div>{{ booking.start_time.strftime('%Y-%m-%d') }}</div>
                            <small class="text-muted">
                                {{ booking.start_time.strftime('%H:%M') }} -
                                {{ booking.end_time.strftime('%H:%M') }}
                            </small>
                        </td>
                        <td>{{ booking.duration_hours }}h</td>
                        <td><strong>₹{{ "%.2f"|format(booking.total_price) }}</strong></td>
                        <td>
                            {% if booking.cancelled %}
                            <span class="badge bg-danger">Cancelled</span>
                            {% elif booking.status == 'completed' %}
                            <span class="badge bg-success">Completed</span>
                            {% else %}
                            <span class="badge bg-primary">Active</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if not booking.cancelled and booking.status == 'active' %}
                            <button type="button" class="btn-cancel-booking"
                                onclick="cancelBooking({{ booking.id }}, '{{ booking.slot.slot_number|format_slot if booking.slot else 'Unknown' }}')">
                                <i class="bi bi-x-circle me-1"></i>Cancel
                            </button>
                            {% else %}
                            <span class="text-muted small">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        {% if page > 1 %}
        <li class="page-item">
            <a class="page-link"
                href="{{ url_for('admin_bookings', status=status_filter, date=date_filter, peak=peak_filter, page=page-1) }}">
                <i class="bi bi-chevron-left"></i> Previous
            </a>
        </li>
        {% endif %}

        {% for p in range(1, total_pages + 1) %}
        {% if p == page %}
        <li class="page-item active"><span class="page-link">{{ p }}</span></li>
        {% elif p <= 3 or p> total_pages - 3 or (p >= page - 1 and p <= page + 1) %} <li class="page-item">
                <a class="page-link"
                    href="{{ url_for('admin_bookings', status=status_filter, date=date_filter, peak=peak_filter, page=p) }}">{{
                    p }}</a>
                </li>
                {% elif p == 4 or p == total_pages - 3 %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
                {% endfor %}

                {% if page < total_pages %} <li class="page-item">
                    <a class="page-link"
                        href="{{ url_for('admin_bookings', status=status_filter, date=date_filter, peak=peak_filter, page=page+1) }}">
                        Next <i class="bi bi-chevron-right"></i>
                    </a>
                    </li>
                    {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
        <h5 class="mt-3">No Bookings Found</h5>
        <p class="text-muted">No bookings match the current filter criteria.</p>
        <a href="{{ url_for('admin_bookings') }}" class="btn btn-outline-primary">
            <i class="bi bi-arrow-clockwise me-1"></i>Clear Filters
        </a>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_css %}
<style>
    .page-link {
        border-radius: 10px;
        margin: 0 2px;
        border: none;
        color: var(--primary);
    }

    .page-item.active .page-link {
        background: var(--primary);
        color: #fff;
    }

    .page-link:hover {
        background: var(--primary-glow);
    }

    code {
        background: #F1F5F9;
        padding: 0.2em 0.5em;
        border-radius: 6px;
        font-size: 0.85em;
        color: var(--text);
    }

    .btn-cancel-booking {
        background: linear-gradient(135deg, #EF4444, #DC2626);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-cancel-booking:hover {
        background: linear-gradient(135deg, #DC2626, #B91C1C);
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    function cancelBooking(bookingId, slotName) {
        // Custom confirmation
        const confirmed = confirm('Are you sure you want to cancel Booking #' + bookingId + '?\n\nSlot: ' + slotName + '\n\nThis action cannot be undone.');

        if (confirmed) {
            // Create and submit the form
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/cancel-booking/' + bookingId;
            document.body.appendChild(form);
            form.submit();
        }
        return false;
    }
</script>
{% endblock %}